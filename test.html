<!DOCTYPE html>
<head>
	<title>judge girl scoreboard</title>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
</head>
<body style = "font-family: Microsoft JhengHei;">
	<table class = "table" id = "table" style = "text-align: center;">
		<thead>
			<tr>
				<th>
					學號
				</th>
				<th>
					姓名
				</th>
				<th class = "0">
					
				</th>
				<th class = "1">
					
				</th>
				<th class = "2">
					
				</th>
				<th>
					破台順序
				</th>
				<th>
					破台時間
				</th>
			</tr>
		</thead>
		<tbody>
			
		</tbody>
	</table>
</body>
<script type="text/javascript">
	var names;
	var pids = [];
	var firstKill = [true, true, true];
	var downstairs = 0;
	var time = -0.5;
	swal({
		text: "Paste student data from excel or google sheets.",
		content: "input"
	}).then(input => {
		names = input.split(/\n|\r|\t| /);
		for (let i = 0; i < names.length; i += 2)
		{
			$("tbody").append("<tr id = " + names[i] +"><td class = \"uid\">" + names[i] + "</td><td class = \"name\">" + names[i + 1] + "</td><td class = \"0\"></td><td class = \"1\"></td><td class = \"2\"></td><td class = \"rank\"></td><td class = \"time\"></td></tr></tr>");
		}
		$("tbody").append("<tr id = \"count\"><td class = \"uid\"></td><td class = \"name\"></td><td class = \"0\">0</td><td class = \"1\">0</td><td class = \"2\">0</td><td class = \"rank\">0</td><td class = \"time\"></td></tr></tr>");
		swal({
			text: "This is a test page, so you don't need to set the start of sid.",
		}).then(function () {
			swal({
				text: "This test page is not live, so the time is not accurate.\nSince the start page is set at 200, you\'ll have to wait for seconds to see the results.\n(If you are using computer, you can get excel files from \"exportxls()\")"
			}).then(function (){
				getScore(200);
			});
		});
	});
	function getScore (page) {
		time += 0.5;
		$.ajax({
			method: 'GET',
			url: 'https://judgegirl.csie.org/api/submissions?page=' + page,
		}).done(function (submit_list){
			for (let i = submit_list.length - 1; i >= 0; i--)
			{
				if (submit_list[i].sid < 427229 || submit_list[i].sid > 427668)
				{
					continue;
				}
				let index = pids.indexOf(submit_list[i].pid);
				if (index == -1)
				{
					pids.push(submit_list[i].pid);
					index = pids.indexOf(submit_list[i].pid);
					$("th." + index).text(submit_list[i].ttl);
				}
				if ($("#" + submit_list[i].lgn).find("." + index).text() == 100)
				{
					continue;
				}
				if (submit_list[i].scr * submit_list[i].factor == 100)
				{
					$("#" + submit_list[i].lgn).find("." + index).text(100);
					if (firstKill[index])
					{
						firstKill[index] = false;
						$("#" + submit_list[i].lgn).find("." + index).css("background-color", "#20F8F8");
					}
					else
					{
						$("#" + submit_list[i].lgn).find("." + index).css("background-color", "#3FBF3F");
					}
					$("#count").find("." + index).text(Number($("#count").find("." + index).text()) + 1);
					let c = 0;
					for (let j = 0; j < 3; j++)
					{
						if ($("#" + submit_list[i].lgn).find("." + j).text() == 100)
						{
							c++;
						}
					}
					if (c == 3)
					{
						if (downstairs == 0)
						{
							$("#" + submit_list[i].lgn).find(".rank").css("background-color", "#FF3399");
							$("#" + submit_list[i].lgn).find(".rank").text(++downstairs);
							$("#" + submit_list[i].lgn).find(".time").text(time);
						}
						else
						{
							$("#" + submit_list[i].lgn).find(".rank").css("background-color", "#FF6600");
							$("#" + submit_list[i].lgn).find(".rank").text(++downstairs);
							$("#" + submit_list[i].lgn).find(".time").text(time);
						}
						$("#count").find(".rank").text(downstairs);
					}
				}
				else
				{
					if ($("#" + submit_list[i].lgn).find("." + index).text() <= submit_list[i].scr * submit_list[i].factor)
					{
						$("#" + submit_list[i].lgn).find("." + index).text(submit_list[i].scr * submit_list[i].factor);
						$("#" + submit_list[i].lgn).find("." + index).css("background-color", "#F8F820");
					}
				}
			}
			getScore(page - 1);
		});
	}
	function exportxls (fileName) {
		if (fileName == undefined)
		{
			fileName = "test";
		}
		let table = document.getElementById("table");
		let html = table.outerHTML;
  		let url = 'data:application/vnd.ms-excel,' + escape(html);
  		let elem = document.createElement("a");
  		elem.setAttribute("href", url);
  		elem.setAttribute("download", fileName + ".xls");
  		elem.click();
  		return false;
	}
</script>